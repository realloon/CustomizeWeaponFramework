# 武器改装界面快速添加制作订单功能 - 实现总结

## 功能概述

实现了在武器改装界面中，当玩家选择某个插槽时，如果库存中没有对应的配件，可以快速添加制作订单到工作台的功能。

## 实现的功能点

### 1. 配件列表显示逻辑
- ✅ 获取插槽可安装的配件列表（通过 `GetCompatibleModuleDefsFor` 方法）
- ✅ 过滤条件：配件类型匹配、未被禁止（存疑存疑存疑是否需要删除被禁止）
- ✅ 如果没有可安装的配件，显示"当前没有支持的配件"

### 2. 库存检查逻辑
- ✅ 检查库存中是否已有配件（参考 `InteractionController.BuildInstallOptions`）
- ✅ 如果库存中有配件：正常显示名称，点击后沿用现有安装流程
- ✅ 如果库存中没有配件：显示配件项，附加说明"库存不足，点击添加制作订单"

### 3. 制作订单添加功能
- ✅ 创建了 `AttachmentCraftingUtility` 工具类
- ✅ 查找能制作指定配件的工作台和配方
- ✅ 将新订单添加到工作台（不判断相同订单是否已存在）
- ✅ 订单命名格式：`为「<武器名称>」制作的「<配件名称>」`

### 4. 性能优化
- ✅ 使用 `Map.listerBuildings.AllBuildingsColonistOfClass<Building_WorkTable>()` 查找工作台
- ✅ 只查找当前地图的工作台，避免全图扫描

### 5. 任务流程
- ✅ 添加订单后不立刻安排小人改装任务
- ✅ 等制作完成后，由玩家主动触发安装逻辑

## 修改的文件

### 1. 新增文件
- `Controllers/AttachmentCraftingUtility.cs` - 工作台订单添加工具类
- `翻译键说明.md` - 新增翻译键说明文档
- `功能实现总结.md` - 本文件

### 2. 修改的文件
- `Controllers/InteractionController.cs` - 修改了 `BuildInstallOptions` 方法，添加库存检查和制作订单功能

## 代码结构

### AttachmentCraftingUtility 类
提供以下静态方法：
- `FindWorkTablesForModule` - 查找能制作指定配件的工作台和配方
- `AddCraftingBill` - 在工作台添加制作订单
- `AddCraftingBillForModule` - 为指定配件查找工作台并添加订单（自动选择第一个可用工作台）

### InteractionController 类修改
- `BuildInstallOptions` 方法：
  - 获取所有兼容的配件定义
  - 检查库存中已有的配件
  - 处理暂存的卸载配件（这些可以直接安装）
  - 为每个兼容的配件创建选项：
    - 库存中有或暂存中有：显示正常安装选项
    - 库存中没有：显示"库存不足，点击添加制作订单"选项
- `CreateAddBillAction` 方法：创建添加制作订单的Action

## 新增翻译键

需要在Mod的翻译文件中添加以下翻译键：

1. **CWF_UI_NoSupportedModules**
   - 中文：当前没有支持的配件
   - 英文：No supported modules

2. **CWF_UI_InsufficientStockClickToAddOrder**
   - 中文：库存不足，点击添加制作订单
   - 英文：Insufficient stock, click to add crafting order

详细说明请参考 `翻译键说明.md` 文件。

## 使用流程

1. 玩家打开武器改装界面
2. 选择某个插槽
3. 系统显示该插槽可安装的配件列表：
   - 如果库存中有配件：显示配件名称，点击可直接安装
   - 如果库存中没有配件：显示"配件名称 (库存不足，点击添加制作订单)"
4. 玩家点击"库存不足"的选项后：
   - 系统查找能制作该配件的工作台
   - 在工作台添加制作订单
   - 订单名称格式：`为「武器名称」制作的「配件名称」`
5. 制作完成后，玩家可以再次打开改装界面，此时库存中已有配件，可以直接安装

## 注意事项

1. **工作台查找**：当前实现会查找所有能制作该配件的工作台，并选择第一个可用工作台。如果项目中有特定的工作台定义，可以进一步优化。

2. **订单重复**：根据需求，系统不会判断相同订单是否已存在，每次都会添加新订单。

3. **翻译文件**：需要在Mod的翻译文件中添加新的翻译键，否则会显示翻译键名称。

4. **性能考虑**：当前实现只查找当前地图的工作台，如果武器在其他地图，可能需要调整查找逻辑。

## 测试建议

1. 测试库存中有配件的情况：应该显示正常安装选项
2. 测试库存中没有配件的情况：应该显示"库存不足"选项
3. 测试点击"库存不足"选项：应该在工作台添加订单
4. 测试订单命名：应该符合格式要求
5. 测试暂存配件：从武器卸载的配件应该可以直接安装，不需要检查库存

如果工作台不存在，显示警告信息。
缓存找到的工作台实例，后续直接调用
